---
title: Jobs
description: Asynchronous tasks.
---

Documentation: <https://laravel.com/docs/9.x/queues>.

In this guide, the queue driver will be database, you have to config your application to use database.

```bash
php artisan queue:table
```

```yml title=".env"
QUEUE_CONNECTION=database
```

```bash
php artisan migrate
```

## Create a new Job

```bash
php artisan make:job ProcessHeavyServerTask
```

## Usage

```php title="app/Jobs/ProcessHeavyServerTask.php"
<?php

namespace App\Jobs;

use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Log;

class ProcessHeavyServerTask implements ShouldQueue
{
  use Dispatchable;
  use InteractsWithQueue;
  use Queueable;
  use SerializesModels;

  /**
   * Create a new job instance.
   */
  public function __construct(
    public mixed $param,
    public mixed $param_alt,
  ) {
  }

  /**
   * Execute the job.
   */
  public function handle()
  {
    // Very heavy server task...

    Log::debug('Success on job '.now());
  }

  public function failed(\Throwable $exception)
  {
    Log::error('Error on job');
  }
}
```

## Call

```php title="app/Http/Controller/MainController.php"
<?php

class MainController extends Controller
{
  public function index()
  {
    $param = [];
    $param_alt = true;

    ProcessHeavyServerTask::dispatch($param, $param_alt);
  }
}
```

## Execute

If you change anything into your job, you have to re-run the command. And for EVERY deployment, you have to restart `supervisor`.

### Local

```bash
php artisan queue:work --queue
```

### Server

Install `supervisor`.

:::tip

Replace `app-name` with the name of your application.

:::

```bash
sudo apt install supervisor -y
```

```bash
cd /etc/supervisor/conf.d
```

```bash
touch /etc/supervisor/conf.d/app-name-worker.conf
```

```bash title="/etc/supervisor/conf.d/app-name-worker.conf"
[program:app-name-worker]
process_name=%(program_name)s_%(process_num)02d
command=php8.1 /home/USER/www/app-name/artisan queue:work database --sleep=3 --tries=3
autostart=true
autorestart=true
user=USER
numprocs=1
redirect_stderr=true
stdout_logfile=/home/USER/www/app-name/storage/logs/worker.log
stopwaitsecs=3600
```

In `/etc/supervisor/supervisord.conf`, check if this exist.

```bash title="/etc/supervisor/supervisord.conf"
[include]
files = /etc/supervisor/conf.d/*.conf
```

When you create a new config, use these commands.

```bash
sudo supervisorctl reread 
sudo supervisorctl update
```

```bash
sudo supervisorctl start app-name-worker:*
```

When you deploy a new app version, restart supervisor worker with this command.

```bash
sudo supervisorctl restart app-name-worker:*
```

#### List all workers

```bash
supervisorctl
```

Example of output.

```bash
bookshelves-worker:bookshelves-worker_00                 RUNNING   pid 40598, uptime 0:03:30
```

Restart it.

```bash
sudo supervisorctl start bookshelves-worker:bookshelves-worker_00
```

#### Manage restart without sudo

```conf title="/etc/supervisor/supervisord.conf"
[unix_http_server]
; add this line
chown = USER:www-data
```

Now `USER` can restart supervisor without `sudo`.
